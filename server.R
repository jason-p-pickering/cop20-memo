library(shiny)
library(shinyjs)
require(shinyWidgets)
require(magrittr)
require(knitr)
require(kableExtra)
source("./utils.R")

shinyServer(function(input, output, session) {
  
  ready <- reactiveValues(ok = FALSE)
  
  fetchMemoData <- function() {
    
    shinyjs::disable("downloadReport")
    if (!user_input$authenticated | !ready$ok)  {
      return(NULL)
    } else {
      
      sendSweetAlert(
        session,
        title = "Fetching data",
        text = "Sit tight. I'm getting your data",
        btn_labels= NA
      )
      
      prio<-memo_getPrioritizationTable(input$ou, d2_session = user_input$d2_session)
      partners<-memo_getPartnersTable(input$ou, d2_session = user_input$d2_session)
      shinyjs::enable("fetch")
      shinyjs::enable("downloadReport")
      closeSweetAlert(session)
      my_data<-list(prio=prio,partners=partners)
      if (is.null(my_data$prio) & is.null(my_data$partners)) {
        sendSweetAlert(
          session,
          title = "Oops!",
          text = "Sorry, I could not find any data for you!"
        )
      }
      return(my_data)
    }
    
  }
  
  memo_data <- reactive({
    fetchMemoData()
  })
  
  user_input <- reactiveValues(authenticated = FALSE, 
                               status = "",
                               d2_session = NULL)
  
  observeEvent(input$login_button, {
    
    tryCatch(  {  datimutils::loginToDATIM(base_url = config$baseurl,
                                           username = input$user_name,
                                           password = input$password) },
               #This function throws an error if the login is not successful
               error=function(e) {
                 sendSweetAlert(
                   session,
                   title = "Login failed",
                   text = "Please check your username/password!",
                   type = "error")
                 flog.info(paste0("User ", input$user_name, " login failed."), name = "datapack")
               } )
    
     if ( exists("d2_default_session"))  {
       
       flog.info(paste0("User ", d2_default_session$user_name, " logged in."), name = "datapack")
       user_input$authenticated<-TRUE
       user_input$d2_session<-d2_default_session$clone()

       }
    
  })
  
  output$prio_table <- DT::renderDataTable({
    
    d <- memo_data() %>% purrr::pluck("prio")
    
    if (!inherits(d, "error") & !is.null(d)) {
      
      DT::datatable(d,options = list(pageLength = 50, 
                                     columnDefs = list(list(className = 'dt-right', 
                                                            targets = 3:8)))) %>% 
        formatCurrency(3:8, '',digits =0)
      
    } else
    {
      NULL
    }
  })
  
  output$partners_table <- DT::renderDataTable({
    
    d <- memo_data() %>% purrr::pluck("partners")
    
    if (!inherits(d, "error") & !is.null(d)) {
      
      DT::datatable(d,options = list(pageLength = 50, 
                                     columnDefs = list(list(className = 'dt-right', 
                                                            targets = 3:dim(d)[2])))) %>% 
        formatCurrency(3:dim(d)[2], '',digits =0)
      
    } else
    {
      NULL
    }
  })
  
  observeEvent(input$fetch, {
    shinyjs::disable("fetch")
    ready$ok <- TRUE
  })
  
  output$uiLogin <- renderUI({
    wellPanel(fluidRow(
      img(src = 'pepfar.png', align = "center"),
      h4(
        "Welcome to the COP20 Memo App. Please login with your DATIM credentials:"
      )
    ),
    fluidRow(
      textInput("user_name", "Username: ", width = "600px"),
      passwordInput("password", "Password:", width = "600px"),
      actionButton("login_button", "Log in!")
    ))
  })
  
  output$ui <- renderUI({
    if (user_input$authenticated == FALSE) {
      ##### UI code for login page
      fluidPage(fluidRow(
        column(
          width = 2,
          offset = 5,
          br(),
          br(),
          br(),
          br(),
          uiOutput("uiLogin"),
          uiOutput("pass")
        )
      ))
    } else {
      wiki_url <- a("Datapack Wiki",
                    href = "https://github.com/pepfar-datim/Data-Pack-Feedback/wiki",
                    target = "_blank")
      
      fluidPage(tags$head(
        tags$style(
          ".shiny-notification {
        position: fixed;
        top: 10%;
        left: 33%;
        right: 33%;}"
        )
      ),
      sidebarLayout(
        sidebarPanel(
          shinyjs::useShinyjs(),
          id = "side-panel",
          tagList(wiki_url),
          tags$hr(),
          selectInput("ou", "Operating Unit",getUserOperatingUnits(user_input$d2_session$user_orgunit)),
          tags$hr(),
          actionButton("fetch","Get Data"),
          tags$hr(),
          downloadButton("downloadXLSX", "Download XLSX"),
          tags$hr(),
          downloadButton("downloadPDF", "Download PDF"),
          tags$hr(),
          downloadButton("downloadDOCX", "Download DOCX"),
          width = 2
        ),
        mainPanel(tabsetPanel(
          id = "main-panel",
          type = "tabs",
          tabPanel("Prioritization", dataTableOutput("prio_table")),
          tabPanel("Partners/Agencies", dataTableOutput("partners_table"))
        ))
      ))
    }
    
  })
  
  
  output$downloadPDF <- downloadHandler(
    filename = function() {
      
      prefix <-"cop_20_approval_memo_"
      date<-format(Sys.time(),"%Y%m%d_%H%M%S")
      paste0(paste(prefix,date,sep="_"),".pdf")
    },
    
    content = function(file) {
      
      src <- normalizePath('approval_memo_template.Rmd')
      img <- normalizePath('pepfar.png')
      # temporarily switch to the temp dir, in case you do not have write
      # permission to the current working directory
      owd <- setwd(tempdir())
      on.exit(setwd(owd))
      file.copy(src, 'report.Rmd', overwrite = TRUE)
      file.copy(img, 'pepfar.png', overwrite = TRUE)
      
      library(rmarkdown)
      out <- rmarkdown::render('report.Rmd', pdf_document(latex_engine = "xelatex"))
      file.rename(out, file)
    }
  )
  
  
  output$downloadDOCX <- downloadHandler(
    filename = function() {
      
      prefix <-"cop_20_approval_memo_"
      date<-format(Sys.time(),"%Y%m%d_%H%M%S")
      paste0(paste(prefix,date,sep="_"),".docx")
    },
    
    content = function(file) {
      
      src <- normalizePath('approval_memo_template_flextable.Rmd')
      img <- normalizePath('pepfar.png')
      # temporarily switch to the temp dir, in case you do not have write
      # permission to the current working directory
      owd <- setwd(tempdir())
      on.exit(setwd(owd))
      file.copy(src, 'report.Rmd', overwrite = TRUE)
      file.copy(img, 'pepfar.png', overwrite = TRUE)
      
      library(rmarkdown)
      out <- rmarkdown::render('report.Rmd', "word_document")
      file.rename(out, file)
    }
  )
  
  
  output$downloadXLSX <- downloadHandler(
    filename = function() {
      
      
      prefix <-"cop_20_approval_memo_"
      date<-format(Sys.time(),"%Y%m%d_%H%M%S")
      paste0(paste(prefix,date,sep="_"),".xlsx")
      
    },
    content = function(file) {
      
      d <- memo_data()
      wb <- openxlsx::createWorkbook()
      openxlsx::addWorksheet(wb,"Prioritization")
      openxlsx::writeDataTable(wb = wb,
                               sheet = "Prioritization",x = d$prio)
      
      
      openxlsx::addWorksheet(wb,"Partners_Agencies")
      openxlsx::writeDataTable(wb = wb,
                               sheet = "Partners_Agencies",x = d$partners)
      openxlsx::saveWorkbook(wb,file=file,overwrite = TRUE)
    }
  )
  
})


