---
#title: "COP20 Approval Memo"
#date: "`r paste0('Generated on ' , format(Sys.time(), '%Y-%m-%d'))`"
output:
  pdf_document:
    toc: no
    latex_engine: xelatex
  html_document:
    toc: no
    df_print: paged
header-includes:
- \usepackage{tabularx,booktabs}
- \usepackage{multirow}
- \usepackage{float}
- \usepackage{xcolor}
- \usepackage{longtable}
- \usepackage{array}
- \usepackage{multirow}
- \usepackage{wrapfig}
- \usepackage{float}
- \usepackage{colortbl}
- \usepackage[normalem]{ulem}
- \usepackage{makecell}
- \usepackage{fancyhdr}
mainfont: FreeSans
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(kableExtra.latex.load_packages = FALSE)
```

\addtolength{\headheight}{0.1cm}
\pagestyle{fancyplain}
```{r header_name ,results='asis', echo=FALSE}
ou_name<-getOrgtuniNamefromUID(input$ou)
cat(paste("\\rhead{Operating Unit: ",ou_name," }"))
cat(paste("\\lhead{Date: ",format(Sys.time(), '%Y-%m-%d'),"}"))
```
\renewcommand{\headrulewidth}{0pt}
\setlength\aboverulesep{0pt}
\setlength\belowrulesep{0pt}

```{r prio_table ,results='asis', echo=FALSE}
if (!exists("d")) {
  d <- memo_data()
}


#Transform all zeros to dashes


d$prio %<>% 
  dplyr::mutate_if(is.numeric, function(x) ifelse(x == 0 ,"-",formatC(x, format="f", big.mark=",",digits = 0)))

total_rows<- ifelse( d$prio$Age ==  "Total",
                     "lightgray","white")

kable(d$prio, "latex", 
      booktabs = T,
      longtable = T,caption = "Prioritization Table") %>%
  column_spec(1,width = "1.2in",bold=TRUE, background = 'white') %>%
  column_spec(2,width = "0.25in", background = total_rows) %>% 
  column_spec(3:9, width = "0.6in", background = total_rows) %>% 
  collapse_rows(columns = 1, latex_hline = "major", valign = "middle") %>% 
  kable_styling(font_size = 8, latex_options = c("repeat_header"))

  cat('\n\n')
  cat('\\pagebreak')
  cat('\n\n')
  
```



```{r partner_table ,results='asis', echo=FALSE}



sub_heading<-names(d$partners)[3:length(d$partners)] %>% stringr::str_split(.," ") %>% purrr::map(purrr::pluck(2)) %>%
  unlist()


group_heading<-names(d$partners)[3:length(d$partners)] %>% stringr::str_split(.," ") %>% purrr::map(purrr::pluck(1)) %>% 
  unlist() %>% 
  factor(.,levels = unique(.)) %>%
  table(.)


```


```{r partner_table_1 ,results='asis', echo=FALSE}
#HTS_INDEX -> TX_PVLS
kable(d$partners[,c(1:14)], "latex", booktabs = T, longtable=T,format.args = list(big.mark = ","),
      col.names = c("Funding Agency","Partner",sub_heading[1:12]), caption = "HTS\\_INDEX to TX\\_PVLS") %>%
  kable_styling(font_size = 8) %>% 
  column_spec(2,width = "1in") %>% 
  column_spec(3:14,width = "0.33in") %>% 
  add_header_above(c("","",group_heading[1:6])) %>% 
  row_spec(which(d$partners$Partner == ""),background = "lightgray")

 cat('\n\n')
  cat('\\pagebreak')
  cat('\n\n')
  
```


```{r partner_table_2 ,results='asis', echo=FALSE}
#CXCA_>PMTCT_EID
kable(d$partners[,c(1:2,15:25)], "latex", booktabs = T, longtable=T,format.args = list(big.mark = ","),
      col.names = c("Funding Agency","Partner",sub_heading[13:23]),
      caption = "CXCA\\_SCRN to PMTCT\\_EID" ) %>%
  kable_styling(font_size = 8, latex_options = c("repeat_header")) %>% 
  column_spec(2,width = "1in") %>% 
  column_spec(3:10,width = "0.33in") %>% 
  add_header_above(c("","",group_heading[7:13])) %>% 
  row_spec(which(d$partners$Partner == ""),background = "lightgray")

 cat('\n\n')
  cat('\\pagebreak')
  cat('\n\n')
  
```


```{r partner_table_3 ,results='asis', echo=FALSE}  
#PP_PREV-> Prep_CURR
kable(d$partners[,c(1:2,26:34)], "latex", booktabs = T, longtable=T,format.args = list(big.mark = ","),
      col.names = c("Funding Agency","Partner",sub_heading[24:32]),
      caption = "PP\\_PREV to PrEP\\_CURR ") %>%
   kable_styling(font_size = 8, latex_options = c("repeat_header")) %>% 
  column_spec(2,width = "1in") %>% 
  column_spec(3:10,width = "0.33in") %>% 
  add_header_above(c("","",group_heading[14:20])) %>% 
  row_spec(which(d$partners$Partner == ""),background = "lightgray")

 cat('\n\n')
  cat('\\pagebreak')
  cat('\n\n')
  
```
  
  
```{r partner_table_4  ,results='asis', echo=FALSE} 

  #TB_STAT->OVC_HIV_STAT
  kable(d$partners[,c(1:2,35:43)], "latex", booktabs = T, longtable=T,format.args = list(big.mark = ","),
      col.names = c("Funding Agency","Partner",sub_heading[33:41]),
      caption = "TB\\_STAT to GEND\\_GBV") %>%
   kable_styling(font_size = 8, latex_options = c("repeat_header")) %>% 
  column_spec(2,width = "1in") %>% 
  column_spec(3:10,width = "0.33in") %>% 
  add_header_above(c("","",group_heading[21:25])) %>% 
  row_spec(which(d$partners$Partner == ""),background = "lightgray")

 cat('\n\n')
  cat('\\pagebreak')
  cat('\n\n')
  
  
```



